
# load packages

```{r}
library(tidyverse)

```

```{r}
library(haven)

```

```{r}
library(dplyr)
library(janitor)
```
```{r}
library(ggplot2)
```


# load data

```{r}

#demo_raw <- read_xpt("P_DEMO.xpt") |> tibble()
#saveRDS(demo_raw, "data/P_DEMO.Rds")
demo_raw <- readRDS("data/P_DEMO.Rds")

```

```{r}
#sleep_raw <- read_xpt("P_SLQ.xpt") |> tibble()
#saveRDS(sleep_raw, "data/P_SLQ.Rds")
sleep_raw <- readRDS("data/P_SLQ.Rds")
```

```{r}
#mental_raw <- read_xpt("P_DPQ.xpt") |> tibble()
#saveRDS(mental_raw, "data/P_DPQ.Rds")
mental_raw <- readRDS("data/P_DPQ.Rds")
```

# clean data

## select and modify variables

```{r}
demo_vars <- demo_raw |>
  select(SEQN, RIDSTATR, RIDAGEYR, DMDEDUC2, DMDYRUSZ) |>
  
  mutate(SEQN = as.character(SEQN)) |>
  
  mutate(Edu = case_when(
    DMDEDUC2 %in% c(1, 2) ~ "Less than HS",  
    DMDEDUC2 == 3 ~ "HS Grad",              
    DMDEDUC2 == 4 ~ "Some College",         
    DMDEDUC2 == 5 ~ "College Grad",         
    DMDEDUC2 %in% c(7, 9) | is.na(DMDEDUC2) ~ NA_character_  # Treat 7, 9, and missing as NA
  )) |>
  mutate(Edu = factor(Edu, levels = c("Less than HS", "HS Grad", "Some College", "College Grad"))) |>
  select(-DMDEDUC2) |>
  
  rename(Age = RIDAGEYR, `Time in US` = DMDYRUSZ) |>
  mutate(`Time in US` = case_when(
    `Time in US` == 1 ~ "<5 yr",
    `Time in US` == 2 ~ "5-15 yr",
    `Time in US` == 3 ~ "15-30 yr",
    `Time in US` == 4 ~ ">30 yr",
    `Time in US` %in% c(77, 99) | is.na(`Time in US`) ~ NA_character_  # Treat 77, 99, and missing as NA
  )) |>
  mutate(`Time in US` = factor(
    `Time in US`, 
    levels = c("<5 yr", "5-15 yr", "15-30 yr", ">30 yr")
  ))

```

```{r}
sleep_vars <- sleep_raw |> 
  select(SEQN, SLQ050, SLD012) |>

  mutate(SEQN = as.character(SEQN)) |>
  
  mutate(`Trb Sleep` = case_when(
    SLQ050 == 1 ~ 1,        # Yes
    SLQ050 == 2 ~ 0,        # No
    SLQ050 %in% c(7, 9) | is.na(SLQ050) ~ NA_real_  # Treat 7, 9, and missing as NA
  )) |>
  mutate(`Trb Sleep` = factor(`Trb Sleep`, levels = c(0, 1), labels = c("No", "Yes"))) |>
  select(-SLQ050) |>

  rename(`Sleep hr` = SLD012)

```

```{r}
mental_vars <- mental_raw |>
  select(SEQN, DPQ020) |>
  mutate(
    SEQN = as.character(SEQN), 
    Depression = case_when(   
      DPQ020 == 0 ~ "None",
      DPQ020 == 1 ~ "Mild",
      DPQ020 == 2 ~ "Moderate",
      DPQ020 == 3 ~ "Severe",
      DPQ020 %in% c(7, 9) | is.na(DPQ020) ~ NA_character_  # Treat 7, 9, and missing as NA
    ),
    Depression = factor(Depression, levels = c("None", "Mild", "Moderate", "Severe"))
  ) |>
  select(-DPQ020) # Remove original DPQ020 column

```

## merge tibbles

```{r}
merged_data <- demo_vars |>
  left_join(mental_vars, by = "SEQN")
merged_data
```
## clean

```{r}
cleaned_data <- merged_data |>
  filter(RIDSTATR == 2, Age >= 21, Age <= 79) |>
  clean_names()

NHANES_Edu <-cleaned_data 
```

```{r}
NHANES_Edu
```
NHANES_Edu Dataset Overview

The NHANES_Edu dataset is a curated subset of the NHANES data, designed to study the correlation of education level with sleep health and mental well-being among adults aged 21â€“79. Key variables include education attainment (categorized into four levels), reported sleep hours, prevalence of sleep disorders, and depressive symptom severity. Additionally, the dataset includes the length of time individuals have lived in the United States ("Time in US") to examine whether duration of residency influences mental health. This variable serves as a potential indicator of stress levels or access to mental health resources, shedding light on its impact on well-being.

This dataset offers a focused perspective on the interplay of education, health, and environmental factors, supporting research and insights into public health challenges.

```{r}
saveRDS(NHANES_Edu, "NHANES_Edu.rds")
#NHANES_Edu <- readRDS("NHANES_Edu.rds")

```

# Codebook

Variable | Role | Old Name | Description 
:--------: | :----: | :--------: | :-----------: 
**SEQN** | ID | `SEQN` | Respondent sequence number


# Analysis 1 - Education on Sleep Disorder
Research question:
How does education level correlate with sleep health (e.g., hours of sleep and prevalence of sleep disorders)?

proportion of edu levels: 

```{r}
# Generate the proportional horizontal stacked bar chart with bolder colors
ggplot(filtered_NHANES_Edu, aes(x = "", fill = edu)) +
  geom_bar(position = "fill", width = 0.5) +  # Narrower bar width
  scale_y_continuous(labels = scales::percent) +
  scale_fill_brewer(palette = "Set2") +  # Use a bolder color palette
  coord_flip() +
  labs(
    title = "Proportion of Education Levels",
    x = "",
    y = "Proportion",
    fill = "Education Level"
  ) +
  theme_minimal(base_size = 14) +  # Larger font size for readability
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),  # Centered and bold title
    legend.position = "right",  # Move legend to the side
    panel.grid.minor = element_blank(),  # Remove minor grid lines
    panel.grid.major.y = element_blank()  # Remove horizontal grid lines
  )


```


```{r}
# Descriptive stats for Sleep Hours by Education Level
edu_sleep_summary <- cleaned_data |>
  group_by(edu) |>
  summarise(
    mean_sleep = mean(sleep_hr, na.rm = TRUE),
    median_sleep = median(sleep_hr, na.rm = TRUE),
    sd_sleep = sd(sleep_hr, na.rm = TRUE),
    count = n()
  )

print(edu_sleep_summary)

```
```{r}
ggplot(cleaned_data, aes(x = edu, y = sleep_hr, fill = edu)) +
  geom_boxplot() +
  labs(
    title = "Distribution of Sleep Hours by Education Level",
    x = "Education Level",
    y = "Sleep Hours"
  ) +
  theme_minimal()

```
```{r}
edu_sleep_correlation <- cor.test(
  as.numeric(cleaned_data$edu),
  cleaned_data$sleep_hr,
  use = "complete.obs"
)

print(edu_sleep_correlation)

```


# Analysis 2 - Education on Mental Health
Researhch question: 
How does education level correlate with mental well-being (e.g., levels of depression)?
Does the length of time living in the US impact mental health, particularly depression levels?

```{r}
# Count of Depression Levels by Education
edu_depression_summary <- cleaned_data |>
  group_by(edu, depression) |>
  summarise(count = n()) |>
  mutate(proportion = count / sum(count))

print(edu_depression_summary)

```
```{r}
ggplot(edu_depression_summary, aes(x = edu, y = proportion, fill = depression)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Proportion of Depression Levels by Education",
    x = "Education Level",
    y = "Proportion",
    fill = "Depression Level"
  ) +
  theme_minimal()

```
```{r}
edu_depression_correlation <- cleaned_data |>
  mutate(depression_numeric = as.numeric(depression)) |>
  summarise(
    correlation = cor(as.numeric(edu), depression_numeric, use = "complete.obs")
  )

print(edu_depression_correlation)

```

```{r}
# Proportion of Depression Levels by Time in US
time_in_us_depression <- cleaned_data |>
  group_by(time_in_us, depression) |>
  summarise(count = n()) |>
  mutate(proportion = count / sum(count))

print(time_in_us_depression)

```
```{r}
ggplot(time_in_us_depression, aes(x = time_in_us, y = proportion, fill = depression)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Proportion of Depression Levels by Time in US",
    x = "Time in US",
    y = "Proportion",
    fill = "Depression Level"
  ) +
  theme_minimal()

```
```{r}
library(gt)

# Summarize the data
time_in_us_summary <- NHANES_Edu |>
  filter(!is.na(time_in_us)) |> 
  group_by(time_in_us) |>
  summarise(
    count = n(),
    proportion = round((n() / nrow(NHANES_Edu)) * 100, 1)
  ) |>
  arrange(desc(count))

# Create the table using `gt`
time_in_us_table <- time_in_us_summary |>
  gt() |>
  tab_header(
    title = "Time in US",
    subtitle = "Number and Proportion of Participants"
  ) |>
  cols_label(
    time_in_us = "Time in US",
    count = "Number of Participants",
    proportion = "Proportion (%)"
  ) |>
  fmt_number(
    columns = vars(proportion),
    decimals = 1
  ) |>
  tab_options(
    table.font.size = "small",
    heading.align = "center"
  )

# Print the table
time_in_us_table

```
Ordinal Logistic Regression: 
```{r}
library(dplyr)

Edu_mental <- NHANES_Edu |>
  dplyr::select(seqn, age, edu, depression, time_in_us)

Edu_mental <- Edu_mental |>
  filter(!is.na(depression), !is.na(edu), !is.na(time_in_us)) |> # Remove NAs
  mutate(
    depression = factor(
      depression,
      levels = c("None", "Mild", "Moderate", "Severe"),
      ordered = TRUE
    )
  )

```

```{r}
# Load the required package
library(MASS)

# Fit the ordinal logistic regression model
ordinal_model <- polr(
  formula = depression ~ edu + time_in_us,
  data = Edu_mental,
  Hess = TRUE
)

# Summarize the model
summary(ordinal_model)

```
```{r}
# Calculate p-values
coefs <- summary(ordinal_model)$coefficients
p_values <- 2 * (1 - pnorm(abs(coefs[, "t value"])))
p_values

```
The results of the ordinal logistic regression analysis indicate that education level is a significant predictor of depression severity, with higher education levels ("Some College" and "College Grad") associated with reduced odds of experiencing more severe depression. In contrast, time spent in the US does not appear to significantly impact depression severity, as all categories for this predictor were non-significant. These findings suggest that education may play a protective role in mental health, potentially due to increased access to resources, coping strategies, or socioeconomic advantages. However, the lack of a significant relationship between time in the US and depression severity highlights the need for further exploration of other potential factors, such as stressors or access to mental health services, that may mediate this relationship. Further model refinement and validation are recommended to confirm these results and explore additional interactions or predictors.

Depression ~ Education Level (Tab 1: Stacked Bar Chart)
```{r}

# Stacked Bar Chart
ggplot(Edu_mental, aes(x = edu, fill = depression)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Depression Proportions by Education Level",
    x = "Education Level",
    y = "Proportion",
    fill = "Depression Severity"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.position = "right"
  )

```
Depression ~ Education Level + Time in US (Tab 2: Grouped Bar Chart)
```{r}
# Grouped Bar Chart
ggplot(Edu_mental, aes(x = edu, fill = depression)) +
  geom_bar(position = "fill") +
  facet_wrap(~ time_in_us) +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Depression by Education Level and Time in US",
    x = "Education Level",
    y = "Proportion",
    fill = "Depression Severity"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.position = "right",
    strip.background = element_rect(fill = "lightblue", color = "white"),
    strip.text = element_text(face = "bold")
  )

```
Depression ~ Education Level + Time in US (Facet Grid)
```{r}
# Facet Grid
ggplot(Edu_mental, aes(x = edu, fill = depression)) +
  geom_bar(position = "fill") +
  facet_grid(. ~ time_in_us) +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Depression by Education Level across Time in US Categories",
    x = "Education Level",
    y = "Proportion",
    fill = "Depression Severity"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    legend.position = "right",
    strip.background = element_rect(fill = "lightblue", color = "white"),
    strip.text = element_text(face = "bold")
  )

```

